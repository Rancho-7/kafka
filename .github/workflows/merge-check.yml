name: Client and Streams Tests

on:
  push:
    branches:
      - CI-TEST2

jobs:
  test-modules:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: [ 11 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false
          gradle-version: wrapper

      - name: Run Tests
        id: run-tests
        run: |
          # è®°å½•å¼€å§‹æ—¶é—´
          start_time=$(date +%s)
          
          # è¿è¡Œæµ‹è¯•
          ./gradlew test \
            --no-daemon \
            --build-cache \
            --continue \
            -PtestLoggingEvents=started,passed,skipped,failed \
            -PmaxParallelForks=2 \
            -PmaxTestRetries=1 \
            -PmaxTestRetryFailures=3 \
            || echo "::warning::Some tests failed"
          
          # è®¡ç®—æŒç»­æ—¶é—´å¹¶æ ¼å¼åŒ–
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          
          hours=$((duration / 3600))
          minutes=$(( (duration % 3600) / 60 ))
          seconds=$((duration % 60))
          
          if [ $hours -gt 0 ]; then
            duration_str="${hours}h${minutes}m${seconds}s"
          else
            duration_str="${minutes}m${seconds}s"
          fi
          
          echo "TOTAL_DURATION=$duration_str" >> $GITHUB_ENV

      - name: Generate Test Summary
        if: always()
        run: |
          {
            # æŸ¥æ‰¾æ‰€æœ‰æµ‹è¯•XMLæ–‡ä»¶å¹¶è¿›è¡Œä¸€æ¬¡æ€§ç»Ÿè®¡
            TEST_DIR="./*/build/test-results/test"
            if [ -d "$TEST_DIR" ]; then
              # ç»Ÿè®¡å„ç±»æµ‹è¯•æ•°é‡
              TOTAL_TESTS=$(find $TEST_DIR -name "TEST-*.xml" -exec xmllint --xpath "count(//testcase)" {} \; 2>/dev/null | awk '{sum += $1} END {print sum}')
              TOTAL_FAILED=$(find $TEST_DIR -name "TEST-*.xml" -exec xmllint --xpath "count(//testcase[.//failure])" {} \; 2>/dev/null | awk '{sum += $1} END {print sum}')
              TOTAL_SKIPPED=$(find $TEST_DIR -name "TEST-*.xml" -exec xmllint --xpath "count(//testcase[.//skipped])" {} \; 2>/dev/null | awk '{sum += $1} END {print sum}')
              TOTAL_FLAKY=$(find $TEST_DIR -name "TEST-*.xml" -exec xmllint --xpath "count(//testcase[contains(@name,'Flaky') or contains(@name,'flaky')])" {} \; 2>/dev/null | awk '{sum += $1} END {print sum}')
              TOTAL_QUARANTINED=$(find $TEST_DIR -name "TEST-*.xml" -exec xmllint --xpath "count(//testcase[contains(@classname,'Quarantined') or contains(@name,'Quarantine')])" {} \; 2>/dev/null | awk '{sum += $1} END {print sum}')

              # è®¡ç®—é€šè¿‡çš„æµ‹è¯•æ•°
              TOTAL_PASSED=$((TOTAL_TESTS - TOTAL_FAILED - TOTAL_SKIPPED - TOTAL_QUARANTINED))
          
              # è¾“å‡ºæ ¼å¼åŒ–çš„æ‘˜è¦
              echo "${TOTAL_TESTS} tests cases run in ${{ env.TOTAL_DURATION }}."
              echo "${TOTAL_PASSED} PASSED âœ…, ${TOTAL_FAILED} FAILED âŒ, ${TOTAL_FLAKY} FLAKY âš ï¸, ${TOTAL_SKIPPED} SKIPPED ğŸ™ˆ, ${TOTAL_QUARANTINED} QUARANTINED ğŸ˜·, and 0 errors."
            else
              echo "No test results found in $TEST_DIR"
            fi
          } >> $GITHUB_STEP_SUMMARY
          
          # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
          cat $GITHUB_STEP_SUMMARY

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-java${{ matrix.java }}
          path: |
            **/build/reports/tests/
            **/build/test-results/
          compression-level: 9
          if-no-files-found: ignore