name: Client and Streams Tests

on:
  push:
    branches:
      - CI-TEST2

jobs:
  test-modules:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: [ 11 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false
          gradle-version: wrapper

      - name: Run tests
        run: |
          # 记录开始时间
          start_time=$(date +%s)
          ./gradlw :clients:test :streams:test --no-scan > test_output.log 2>&1 || echo "Tests failed"
          # 记录结束时间并计算总耗时
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          # 转换为分钟和秒
          minutes=$((duration / 60))
          seconds=$((duration % 60))
          echo "TOTAL_DURATION=${minutes}m ${seconds}s" >> $GITHUB_ENV

      - name: Generate test summary
        run: |
          {
            # 直接计算所有测试的统计数据
            TOTAL_TESTS=$(find . -path "*/build/test-results/test" -name "TEST-*.xml" -exec grep "<testcase" {} \; | wc -l)
            TOTAL_FAILED=$(find . -path "*/build/test-results/test" -name "TEST-*.xml" -exec grep "<failure" {} \; | wc -l)
            TOTAL_SKIPPED=$(find . -path "*/build/test-results/test" -name "TEST-*.xml" -exec grep "<skipped" {} \; | wc -l)
            TOTAL_FLAKY=$(find . -path "*/build/test-results/test" -name "TEST-*.xml" -exec grep -l -E 'class=".*\.Flaky.*Test|@Flaky|flaky="true"' {} \; | xargs -r grep "<testcase" 2>/dev/null | wc -l)
            TOTAL_QUARANTINED=$(find . -path "*/build/test-results/test" -name "TEST-*.xml" -exec grep -l -E 'class=".*\.Quarantined.*Test|@Quarantine|quarantined="true"' {} \; | xargs -r grep "<testcase" 2>/dev/null | wc -l)

            # 输出格式化的摘要
            echo "# Test Summary"
            echo
            echo "${TOTAL_TESTS} tests cases run in ${{ env.TOTAL_DURATION }}"
            echo "${TOTAL_FAILED} Failed, ${TOTAL_FLAKY} Flaky, ${TOTAL_SKIPPED} Skipped, ${TOTAL_QUARANTINED} Quarantined, and 0 errors"
          } >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-java${{ matrix.java }}
          path: |
            clients/build/reports/tests/
            streams/build/reports/tests/
          compression-level: 9
          if-no-files-found: ignore